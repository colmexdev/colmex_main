<div class="chart-cont" id="cont-1">
	<svg id="svg1">
	</svg>
</div>

<div class="chart-cont" id="cont-2">
	<svg id="svg_p">
	</svg>
</div>

<div class="chart-cont" id="cont-devs">
	<svg id="svg_devs">
	</svg>
</div>

<div class="chart-cont" id="cont-descs">
	<svg id="svg_descs">
	</svg>
</div>

<div id="query-output"></div>

<script type="text/javascript">
	$.ajax({
		url: "<%= panel_princ_path %>",
		dataType: "JSON",
		success: function(result){
			//Variables para filtrado
			var dataset = crossfilter(result["groups"]);

			var objetosPorTipo = dataset.dimension(function(d){return d["tipo"]});
			var objetosPorFechaUpd = dataset.dimension(function(d){return d["fecha_upd"]});
			var objetosPorFechaGen = dataset.dimension(function(d){return d["fecha_creacion"]});

			//var objetosAgrupadosPorTipo = objetosPorTipo.group();
			//var objetosAgrupadosPorFechaUpd = objetosPorFechaUpd.group();
			//var objetosAgrupadosPorFechaGen = objetosPorFechaGen.group();

			var objetosFiltradosPorFecha = objetosPorFechaUpd.filter(function(d){ return (new Date(d).getTime() >= new Date(result["last_time"]).getTime() && new Date(d).getTime() <= new Date("<%= Date.today %>").getTime())});

			var objetosContadosPorFecha = objetosFiltradosPorFecha.group().reduceCount(function(d){ return d}).top(Infinity);
			var objetosContadosPorTipo = objetosPorTipo.group().reduceCount(function(d){return d}).top(Infinity);

			var fechas_ac = completaFechas(new Date(result["last_time"]),new Date("<%= Date.today %>"));
			var total_upds = 0;
			for(var j=0; j<fechas_ac.length; j++){
				for(var i=0; i<objetosContadosPorFecha.length; i++){
					if(fechas_ac[j]["key"].getTime() == new Date(objetosContadosPorFecha[i].key).getTime()){
						total_upds = total_upds + objetosContadosPorFecha[i].value;
						fechas_ac[j]["value"] = objetosContadosPorFecha[i].value;
						break;
					}
				}
			}
			//Variables para graficación
			var margins = {t: 20, b: 20, r: 30, l: 30};
			var sizes = {uc: {w: 950, h: 600}, pc: {w: 500, h: 500}};

			//Gráfica de tiempo (Línea)
			var x = escala('t',[new Date(result["last_time"]),new Date("<%= Date.today %>")],[0,sizes["uc"]["w"]-margins["l"]]);

			var y = escala('l',[0,d3.max(objetosContadosPorFecha,function(d){ return d.value})],[sizes["uc"]["h"]-margins["b"]-margins["t"],0]);

			var xAxis = eje('b',x,30,2,-2,d3.timeFormat("%d/%m"));
			var yAxis = eje('r',y,10,2,-2);

			var svg = d3.select("#cont-1")
				.style("max-width","1100px")
				.style("height",sizes["uc"]["h"]+"px")
				.style("min-width",sizes["uc"]["w"]+"px")
				.select("#svg1")
  	 		.attr("preserveAspectRatio", "xMinYMin meet")
   			.attr("viewBox", "0 0 "+sizes["uc"]["w"]+" "+sizes["uc"]["h"]);

			var gX = svg.append("g")
				.attr("class", "axis axis-x")
				.attr("transform","translate("+margins["l"]+","+(sizes["uc"]["h"]-margins["b"])+")")
				.call(xAxis);

			var gY = svg.append("g")
				.attr("class", "axis axis-y")
				.attr("transform","translate("+margins["l"]+","+(margins["t"])+")")
				.call(yAxis);

			var linea_t = linea(x,y,d3.curveMonotoneX,0,1);

			traceFigures("#svg1",[fechas_ac],"line-time","path",{"class":"line","transform":"translate("+margins["l"]+","+(margins["t"])+")","fill":"none","stroke":"black","d":linea_t});

			traceFigures("#svg1",fechas_ac,"nodes","circle",{"class":"nodes","transform":"translate("+margins["l"]+","+(margins["t"])+")","id":function(d,i){return "punto-" + i},"r":"3px","cx":function(d){ return x(new Date(d["key"]))},"cy":function(d){ return y(d["value"])},"stroke":"#dddddd","stroke-width": 3},x,y);
				
			//Gráfica de porcentajes (Pastel)
			pieChart("#cont-2",{"max-width":"500px","height":sizes["pc"]["h"]+"px","min-width":sizes["pc"]["w"]+"px"},"#svg_p",[sizes["pc"]["w"],sizes["pc"]["h"]],"pie_chart",[20,180],[0.8,9],"sect",objetosContadosPorTipo);

		}
	});
</script>
<script type="text/javascript">
  var CLIENT_ID = '384237971543-uv4rn3cj3m33v5trf0oip7ff03ojl1fm.apps.googleusercontent.com';

  // Set authorized scope.
  var SCOPES = ['https://www.googleapis.com/auth/analytics.readonly'];


  function authorize(event) {
    // Handles the authorization flow.
    // `immediate` should be false when invoked from the button click.
    var useImmdiate = false;
    var authData = {
      client_id: CLIENT_ID,
      scope: SCOPES,
      immediate: useImmdiate
    };

    gapi.auth.authorize(authData, function(response) {
      if (response.error) {
        alert("Error en recabación de analíticos");
      }
      else {
        queryAccounts();
      }
    });
  }


function queryAccounts() {
  // Load the Google Analytics client library.
  gapi.client.load('analytics', 'v3').then(function() {

    // Get a list of all Google Analytics accounts for this user
    gapi.client.analytics.management.accounts.list().then(handleAccounts);
  });
}


function handleAccounts(response) {
  // Handles the response from the accounts list method.
  if (response.result.items && response.result.items.length) {
    // Get the first Google Analytics account.
    var firstAccountId = response.result.items[0].id;

    // Query for properties.
    queryProperties(firstAccountId);
  } else {
    console.log('No accounts found for this user.');
  }
}


function queryProperties(accountId) {
  // Get a list of all the properties for the account.
  gapi.client.analytics.management.webproperties.list(
      {'accountId': accountId})
    .then(handleProperties)
    .then(null, function(err) {
      // Log any errors.
      console.log(err);
  });
}


function handleProperties(response) {
  // Handles the response from the webproperties list method.
  if (response.result.items && response.result.items.length) {

    // Get the first Google Analytics account
    var firstAccountId = response.result.items[0].accountId;

    // Get the first property ID
    var firstPropertyId = response.result.items[0].id;

    // Query for Views (Profiles).
    queryProfiles(firstAccountId, firstPropertyId);
  } else {
    console.log('No properties found for this user.');
  }
}


function queryProfiles(accountId, propertyId) {
  // Get a list of all Views (Profiles) for the first property
  // of the first Account.
  gapi.client.analytics.management.profiles.list({
      'accountId': accountId,
      'webPropertyId': propertyId
  })
  .then(handleProfiles)
  .then(null, function(err) {
      // Log any errors.
      console.log(err);
  });
}


function handleProfiles(response) {
  // Handles the response from the profiles list method.
  if (response.result.items && response.result.items.length) {
    // Get the first View (Profile) ID.
    var firstProfileId = response.result.items[0].id;

    // Query the Core Reporting API.
    queryCoreReportingApi(firstProfileId);
  } else {
    console.log('No views (profiles) found for this user.');
  }
}


function queryCoreReportingApi(profileId) {
  // Query the Core Reporting API for the number sessions for
  // the past seven days.
  gapi.client.analytics.data.ga.get({
    'ids': 'ga:128026521',
    'start-date': '30daysAgo',
    'end-date': 'today',
    'metrics': 'ga:users',
		'dimensions': 'ga:deviceCategory'
  })
  .then(function(response) {
		var results = response.result.rows;
		var data_devs = [];
		for(var a in results){
			data_devs.push({key: results[a][0],value: +results[a][1]});
		}
			pieChart("#cont-devs",{"max-width":"500px","height":500+"px","min-width":500+"px"},"#svg_devs",[500,500],"pie_devs",[50,180],[0.8,9],"sect",data_devs);
    //var formattedJson = JSON.stringify(response.result, null, 2);
    //document.getElementById('query-output').innerHTML += "<br><br>" + formattedJson;
  })
  .then(null, function(err) {
      // Log any errors.
      console.log(err);
  });

  gapi.client.analytics.data.ga.get({
    'ids': 'ga:128026521',
    'start-date': '30daysAgo',
    'end-date': 'today',
    'metrics': 'ga:totalEvents',
		'dimensions': 'ga:eventAction'
  })
  .then(function(response) {

		var margins = [50,50,50,50];
		var sizes = [800,1100];

		var results = response.result.rows;
		var data_descs = [];
		var keys = [];
		for(var a in results){
			data_descs.push({key: results[a][0].replace("Click a Descubre: ",""),value: +results[a][1]});
			keys.push(results[a][0].replace("Click a Descubre: ",""));
		}
		var cont_descs = containerSelect("#cont-descs",{"min-width":"750px","height":"1100px", "max-width":"900px"}).select("#svg_descs");
		var x_desc = escala("l",[0,d3.max(data_descs,function(d){return d.value})],[50,750]);
		var y_desc = escala("b",keys,[50,1000],[0.4,0]);
		console.log(y_desc.domain[0] + " " + y_desc.domain);
		var xAxis = eje('b',x_desc,30,2,-2);
		var yAxis = eje('r',y_desc,data_descs.length,2,-2);
		console.log(yAxis);
		var gX = cont_descs.append("g")
			.attr("class", "axis axis-x")
			.attr("transform","translate("+margins[3]+","+margins[0]+")")
			.call(xAxis);

		var gY = cont_descs.append("g")
			.attr("class", "axis axis-y")
			.attr("transform","translate("+margins[3]+","+margins[0]+")")
			.call(yAxis);

		traceFigures("#svg_descs",data_descs,"desc-bar","rect",{"class":"desc-bar","transform":"translate("+margins[3]+","+(margins[0])+")","id":function(d,i){return "desc-bar-" + i},"x":x_desc(0),"y":function(d){return y_desc(d.key)},"width":function(d){return x_desc(d.value)},"height":y_desc.bandwidth(),"fill":"black",}, x_desc ,y_desc);
			
    /*var formattedJson = JSON.stringify(response.result, null, 2);
    document.getElementById('query-output').innerHTML = formattedJson;*/
  })
  .then(null, function(err) {
      // Log any errors.
      console.log(err);
  });
/*
  gapi.client.analytics.data.ga.get({
    'ids': 'ga:128026521',
    'start-date': '30daysAgo',
    'end-date': 'today',
    'metrics': 'ga:users,ga:sessions,ga:avgSessionDuration,ga:bounceRate',
		'dimensions': 'ga:date'
  })
  .then(function(response) {
    var formattedJson = JSON.stringify(response.result, null, 2);
    document.getElementById('query-output').innerHTML += "<br><br>" + formattedJson;
  })
  .then(null, function(err) {
      // Log any errors.
      console.log(err);
  });

  gapi.client.analytics.data.ga.get({
    'ids': 'ga:128026521',
    'start-date': '30daysAgo',
    'end-date': 'today',
    'metrics': 'ga:users',
		'dimensions': 'ga:date,ga:hour'
  })
  .then(function(response) {
    var formattedJson = JSON.stringify(response.result, null, 2);
    document.getElementById('query-output').innerHTML += "<br><br>" + formattedJson;
  })
  .then(null, function(err) {
      // Log any errors.
      console.log(err);
  });

  gapi.client.analytics.data.ga.get({
    'ids': 'ga:128026521',
    'start-date': '30daysAgo',
    'end-date': 'today',
    'metrics': 'ga:users',
		'dimensions': 'ga:date,ga:medium'
  })
  .then(function(response) {
    var formattedJson = JSON.stringify(response.result, null, 2);
    document.getElementById('query-output').innerHTML += "<br><br>" + formattedJson;
  })
  .then(null, function(err) {
      // Log any errors.
      console.log(err);
  });

  gapi.client.analytics.data.ga.get({
    'ids': 'ga:128026521',
    'start-date': '30daysAgo',
    'end-date': 'today',
    'metrics': 'ga:users',
		'dimensions': 'ga:date,ga:source'
  })
  .then(function(response) {
    var formattedJson = JSON.stringify(response.result, null, 2);
    document.getElementById('query-output').innerHTML += "<br><br>" + formattedJson;
  })
  .then(null, function(err) {
      // Log any errors.
      console.log(err);
  });

  gapi.client.analytics.data.ga.get({
    'ids': 'ga:128026521',
    'start-date': '30daysAgo',
    'end-date': 'today',
    'metrics': 'ga:users',
		'dimensions': 'ga:date,ga:country'
  })
  .then(function(response) {
    var formattedJson = JSON.stringify(response.result, null, 2);
    document.getElementById('query-output').innerHTML += "<br><br>" + formattedJson;
  })
  .then(null, function(err) {
      // Log any errors.
      console.log(err);
  });

  gapi.client.analytics.data.ga.get({
    'ids': 'ga:128026521',
    'start-date': '30daysAgo',
    'end-date': 'today',
    'metrics': 'ga:1dayUsers',
		'dimensions': 'ga:date'
  })
  .then(function(response) {
    var formattedJson = JSON.stringify(response.result, null, 2);
    document.getElementById('query-output').innerHTML += "<br><br>" + formattedJson;
  })
  .then(null, function(err) {
      // Log any errors.
      console.log(err);
  });

  gapi.client.analytics.data.ga.get({
    'ids': 'ga:128026521',
    'start-date': '30daysAgo',
    'end-date': 'today',
    'metrics': 'ga:7dayUsers',
		'dimensions': 'ga:date'
  })
  .then(function(response) {
    var formattedJson = JSON.stringify(response.result, null, 2);
    document.getElementById('query-output').innerHTML += "<br><br>" + formattedJson;
  })
  .then(null, function(err) {
      // Log any errors.
      console.log(err);
  });

 /* gapi.client.analytics.data.ga.get({
    'ids': 'ga:128026521',
    'start-date': '30daysAgo',
    'end-date': 'today',
    'metrics': 'ga:30dayUsers',
		'dimensions': 'ga:date'
  })
  .then(function(response) {
    var formattedJson = JSON.stringify(response.result, null, 2);
    document.getElementById('query-output').innerHTML += "<br><br>" + formattedJson;
  })
  .then(null, function(err) {
      // Log any errors.
      console.log(err);
  });

  gapi.client.analytics.data.ga.get({
    'ids': 'ga:128026521',
    'start-date': '30daysAgo',
    'end-date': 'today',
    'metrics': 'ga:cohortRetetnionRate',
		'dimensions': 'ga:cohortNthDay,ga:cohortNthWeek,ga:cohortNthMonth'
  })
  .then(function(response) {
    var formattedJson = JSON.stringify(response.result, null, 2);
    document.getElementById('query-output').innerHTML += "<br><br>" + formattedJson;
  })
  .then(null, function(err) {
      // Log any errors.
      console.log(err);
  });
*/
}
</script>

<script src="https://apis.google.com/js/client.js?onload=authorize"></script>
