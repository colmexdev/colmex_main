<div>
	<svg id="svg1" width="950" height="600">
	</svg>
</div>

<script type="text/javascript">
	$.ajax({
		url: "<%= panel_princ_path %>",
		dataType: "JSON",
		success: function(result){
			//Variables para filtrado
			var dataset = crossfilter(result["groups"]);

			var objetosPorTipo = dataset.dimension(function(d){return d["tipo"]});
			var objetosPorFechaUpd = dataset.dimension(function(d){return d["fecha_upd"]});
			var objetosPorFechaGen = dataset.dimension(function(d){return d["fecha_creacion"]});

			//var objetosAgrupadosPorTipo = objetosPorTipo.group();
			//var objetosAgrupadosPorFechaUpd = objetosPorFechaUpd.group();
			//var objetosAgrupadosPorFechaGen = objetosPorFechaGen.group();

			var objetosFiltradosPorFecha = objetosPorFechaUpd.filter(function(d){ return (new Date(d["fecha_upd"]).getTime() >= new Date(result["last_time"]).getTime() && new Date(d["fecha_upd"]).getTime() <= new Date("<%= Date.today %>").getTime())});

			var objetosContadosPorFecha = objetosFiltradosPorFecha.group().reduceCount(function(d){ return d["fecha_upd"]}).top(Infinity);
			console.log(objetosAgrupadosPorTipo.all());

			var fechas_ac = completaFechas(new Date(result["last_time"]),new Date("<%= Date.today %>"));
			var total_upds = 0;
			for(var j=0; j<fechas_ac.length; j++){
				for(var i=0; i<objetosContadosPorFecha.length; i++){
					if(fechas_ac[j]["fecha"].getTime() == new Date(objetosContadosPorFecha[i].key).getTime()){
						total_upds = total_upds + objetosContadosPorFecha[i].value;
						fechas_ac[j]["val"] = objetosContadosPorFecha[i].value;
						break;
					}
				}
			}
			console.log(total_upds);
			//Variables para graficaciÃ³n
			var margins = {t: 20, b: 20, r: 30, l: 30};
			var sizes = {uc: {w: 950, h: 600}};
			var x = escala('t',[new Date(result["last_time"]),new Date("<%= Date.today %>")],[0,sizes["uc"]["w"]-margins["l"]]);

			var y = escala('l',[0,d3.max(objetosContadosPorFecha,function(d){ return d.value})],[sizes["uc"]["h"]-margins["b"]-margins["t"],0]);

			var xAxis = eje('b',x,30,2,-2,d3.timeFormat("%d/%m"));
			var yAxis = eje('r',y,10,2,-2);

			var svg = d3.select("#svg1");

			var gX = svg.append("g")
				.attr("class", "axis axis-x")
				.attr("transform","translate("+margins["l"]+","+(sizes["uc"]["h"]-margins["b"])+")")
				.call(xAxis);

			var gY = svg.append("g")
				.attr("class", "axis axis-y")
				.attr("transform","translate("+margins["l"]+","+(margins["t"])+")")
				.call(yAxis);

			var linea = d3.line()
				.x(function(d){return x(new Date(d["fecha"]))})
				.y(function(d){return y(d["val"])})
				.curve(d3.curveMonotoneX);

			var uc_line = svg.append("path")
      	.data([fechas_ac])
      	.attr("class", "line")
				.attr("transform","translate("+margins["l"]+","+(margins["t"])+")")
				.attr("fill","none")
				.attr("stroke","black")
      	.attr("d", linea);

			var circulos = svg.selectAll(".nodes")
				.data(fechas_ac)
				.enter().append("circle")
				.attr("transform","translate("+margins["l"]+","+(margins["t"])+")")
				.attr("id",function(d,i){return "punto-" + i})
				.attr("r", "3px")
				.attr("cx", function(d){ return x(new Date(d["fecha"]))})
				.attr("cy", function(d){ return y(d["val"])})
				.attr("stroke", "#dddddd")
				.attr("stroke-width", 2);
				
		}
	});
</script>
