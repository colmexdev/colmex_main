class PanelController < ApplicationController
  before_action :select_set, only: [:principal, :index, :mostrar, :generar, :crear, :eliminar, :actualizar, :editar]
  before_action :get_object_fields, only: [:index, :crear, :actualizar, :eliminar, :mostrar]

  def principal
		grupos = @sets.map {|k,v| v[:model]}
    @groups = []
    grupos.each_with_index do |g,i|
      begin
        @groups << g.where("created_at >= ? OR updated_at >= ?", Date.today-30, Date.today-30).pluck(:nombre,:created_at,:updated_at).map {|x| {nombre: x[0], fecha_creacion: x[1].to_date, fecha_upd: x[2].to_date, tipo: @sets.keys[i].to_s}}
      rescue Exception => e
        #next
      end
      begin
        @groups << g.where("created_at >= ? OR updated_at >= ?", Date.today-30, Date.today-30).pluck(:titulo,:created_at,:updated_at).map {|x| {nombre: x[0], fecha_creacion: x[1].to_date, fecha_upd: x[2].to_date, tipo: @sets.keys[i].to_s}}
      rescue Exception => e
        #next
      end
      begin
        @groups << g.where("created_at >= ? OR updated_at >= ?", Date.today-30, Date.current-30).pluck(:cita,:created_at,:updated_at).map {|x| {nombre: x[0], fecha_creacion: x[1].to_date, fecha_upd: x[2].to_date, tipo: @sets.keys[i].to_s}}
      rescue Exception => e
        #next
      end
      begin
        @groups << g.where("created_at >= ? OR updated_at >= ?", Date.today-30, Date.current-30).pluck(:badge,:created_at,:updated_at).map {|x| {nombre: x[0], fecha_creacion: x[1].to_date, fecha_upd: x[2].to_date, tipo: @sets.keys[i].to_s}}
      rescue Exception => e
        #next
      end
    end
    @groups = @groups.reject{|g| g.empty?}.flatten
    respond_to do |format|
      format.js
      format.json {render json: {groups: @groups, last_time: (Date.current() - 30)}}
    end
  end

  def panel
  end

  def index
    if params[:keyword].present?
      query
      @query = @query + (params[:complement].present? ? (" and " + params[:complement]) : "")
    else
      @query = (params[:complement].present? ? params[:complement] : "")
    end
    @rpp = 10
		@m = @sets[params[:set].to_sym][:model]
    @mod = (@m.class.to_s != "Array" ? @m : @m[0])
    @count = @mod.where(@query.present? ? @query : "").count
    @set = @mod.where(@query.present? ? @query : "").order(updated_at: :desc).limit(@rpp).offset(params[:offset].to_i*@rpp)

    @pags = (@count == 0 ? 0 : ((@count / @rpp) + (@count % @rpp == 0 ? 0 : 1) ))
    respond_to do |format|
      format.js
      #format.json {render json: {filas: @set} }
    end
  end

  def mostrar
		@obj = @sets[params[:set].to_sym][:model].find(params[:id].to_i)
    respond_to do |format|
      format.js
    end
  end

  def generar
    @obj = @sets[params[:set].to_sym][:model].new
    respond_to do |format|
      format.js
    end
  end

  def crear
    @obj = @sets[params[:set].to_sym][:model].new(obj_params)
    respond_to do |format|
      if @obj.save
        if @sets[params[:set].to_sym][:model] == Sitio
          i = 0
          while i < obj_params[:num_parrafos].to_i
            @pf = Parrafo.new({sitio_id: @obj.id, p_ind: i})
            @pf.save
            i = i + 1
          end
          i = 0
          while i < obj_params[:num_fotos].to_i
            @pf = Foto.new({sitio_id: @obj.id, f_ind: i})
            @pf.save
            i = i + 1
          end
        end
        format.js { render :mostrar, params: {set: params[:set]}, notice: 'Objeto generado exitosamente.' }
      else
        format.js { render :generar }
        format.json { render json: @obj.errors, status: :unprocessable_entity }
      end
    end
  end

  def editar
    if @sets[params[:set].to_sym][:model].class.to_s != "Array"
      @obj = @sets[params[:set].to_sym][:model].find(params[:id])
    elsif params[:set] == "Contenido de sitios"
      @obj = Sitio.find(params[:id])
      @pars = Parrafo.where("sitio_id = ?",params[:id].to_i)
      @pics = Foto.where("sitio_id = ?",params[:id].to_i)
    end
  end

  def actualizar
    @obj = @sets[params[:set].to_sym][:model].find(params[:id])
    respond_to do |format|
      if params[:set] == "Contenido de sitios"
        @llaves = [params[:pars].keys,params[:pics].keys]
        @vals = [params[:pars].values,params[:pics].values]
        params[:pars].each_with_index do |p,i|
          Parrafo.find(@llaves[0][i].to_i).update(par_params(ActionController::Parameters.new(@vals[0][i])))
        end
        params[:pics].each_with_index do |p,i|
          Foto.find(@llaves[1][i].to_i).update(pic_params(ActionController::Parameters.new(@vals[0][i])))
        end
      elsif @obj.update(obj_params)
        if @sets[params[:set].to_sym][:model] == Sitio
          @num_pars = Parrafo.where("sitio_id = ?", params[:id])
          @num_fotos = Foto.where("sitio_id =?", params[:id])

          if @num_pars.count < obj_params[:num_parrafos].to_i
            k = 0
            while k < obj_params[:num_parrafos].to_i
              if Parrafo.where("sitio_id = ? and p_ind = ? ", params[:id].to_i, k).count == 0
                @pf = Parrafo.new({sitio_id: params[:id].to_i, p_ind: k})
                @pf.save
              end
              k = k + 1
            end
          else
            while @num_pars.count > obj_params[:num_parrafos].to_i
              @num_pars[-1].destroy
            end
          end

          if @num_fotos.count < obj_params[:num_fotos].to_i
            k = 0
            while k < obj_params[:num_fotos].to_i
              if Foto.where("sitio_id = ? and f_ind = ? ",params[:id].to_i, k).count == 0
                @pf = Foto.new({sitio_id: params[:id].to_i, f_ind: k})
                @pf.save
              end
              k = k + 1
            end
          else
            while @num_fotos.count > obj_params[:num_fotos].to_i
              @num_fotos[-1].destroy
            end
          end

        end
        format.js { render :mostrar, params: {set: params[:set]}, notice: 'Objeto generado exitosamente.' }
      else
        format.js { render :editar }
        format.json { render json: @obj.errors, status: :unprocessable_entity }
      end
    end
  end

  def eliminar
		@sets[params[:set].to_sym][:model].find(params[:id]).destroy
    if params[:set] == "Catálogo de sitios"
      Parrafo.where("sitio_id = ?", params[:id].to_i).destroy_all
      Foto.where("sitio_id = ?", params[:id].to_i).destroy_all
    end
    @set = @sets[params[:set].to_sym][:model].order(updated_at: :desc).limit(@rpp).offset(0)
    @rpp = 10
    @count = @sets[params[:set].to_sym][:model].count
    @pags = (@count == 0 ? 0 : ((@count / @rpp) + (@count % @rpp == 0 ? 0 : 1) ))
		respond_to do |format|
      format.js { render :index, params: {set: params[:set]}, notice: 'Se ha eliminado el objeto exitosamente'}
		  format.json { head :no_content }
		end
  end

  private

  def query
    @query = "("
    @fields.keys.each do |f|
      @query = @query + f.to_s + " like '%" + params[:keyword] + "%'" + (f == @fields.keys[-1] ? ")" : " or ")
    end
  end

  def select_set
    @sets = {
      "Profesores eméritos": {
        model: Emerito, 
        fields: {nombre: "Nombre",fecha_anexion: "Fecha de anexión",centro: "Centro",semblanza: "Semblanza",semblanza_eng: "Semblanza (Inglés)"}, 
        imgs: {foto: "Foto"}
      }, "Programas docentes": {
        model: Curso,
        fields: {titulo: "Título",descripcion: "Descripción",fecha_inicio_conv: "Inicio de convocatoria",fecha_fin_conv: "Fin de convocatoria",fecha_inicio_clases: "Inicio de clases",fecha_fin_clases: "Fin de clases",liga: "Link",programa: "Programa docente",tipo_curso: "Tipo de curso",imparte: "Impartido por",traduccion_tit: "Título (Inglés)", traduccion_desc: "Descripción (Inglés)"},
        imgs: {foto: "Foto"}
      }, "Directorio de Autoridades": {
        model: Personal,
        fields: {nombre: "Nombre",seccion: "Sección",correo: "Correo electrónico",telefono: "Teléfono",extension: "Extensión",depto: "Departamento",cargo: "Cargo"},
        imgs: {foto: "Foto"}
      }, "Categorías de Premios": {
        model: Categorium,
        fields: {nombre: "Nombre", nombre_eng: "Nombre (Inglés)"},
        imgs: {}
      }, "Premios y distinciones": {
        model: Premiado,
        fields: {nombre: "Nombre", descripcion: "Descripción",tipo_premio: "Otorgado a",tipo: "Sección (comunidad)",liga: "Link"},
        imgs: {}
      }, "Documentos varios": {
        model: Documento,
        fields: {nombre: "Título",nombre_eng: "Título (Inglés)",tipo: "Sección",anio: "Año",liga: "Link"},
        imgs: {archivo: "Archivo"}
      }, "Descubre": {
        model: Descubre,
        fields: {titulo: "Título",liga: "Link",contenido: "Categoría",fecha_publicacion: "Fecha de despliegue",fecha_limite_pub: "Fecha de expiración",tags: "Etiquetas"},
        imgs: {imagen: "Imagen"}
      }, "Categorías de 'Descubre'": {
        model: Content,
        fields: {tipo: "Tipo",tipo_eng: "Tipo (Inglés)"},
        imgs: {icono: "Ícono"}
      }, "Imágenes de slider": {
        model: Slider,
        fields: {liga: "Link",fecha_expiracion: "Fecha de expiración",posicion: "Posición (badge)"},
        imgs: {imagen: "Imagen",badge: "Badge", badge_eng: "Badge (Inglés)"}
      }, "Cátedras y seminarios": {
        model: Catedra,
        fields: {titulo: "Título",titulo_eng: "Título (Inglés)",descripcion: "Descripción",descripcion_eng: "Descripción (Inglés)",tipo: "Tipo",liga: "Link"},
        imgs: {}
      }, "Frases en página principal": {
        model: Frase,
        fields: {cita: "Cita",cita_eng: "Cita (Inglés)",autor: "Autor"},
        imgs: {}
      }, "Directorio académico": {
        model: Academico,
        fields: {nombre: "Nombre",inicial: "Inicial",correo: "Correo electrónico",adscripcion: "Centro de Estudios",lineas_investigacion: "Líneas de investigación",pagina: "Sitio personal"},
        imgs: {foto: "Foto"}
      }, "Usuarios gestores": {
        model: Admin,
        fields: {usuario: "Usuario",admin: "Tipo"},
        imgs: {}
      }, "Catálogo de sitios": {
        model: Sitio,
        fields: {ref: "Página", partial: "URL", num_parrafos: "Párrafos", num_fotos: "Fotos"},
        imgs: {}
      }, "Contenido de sitios": {
        model: [Sitio,Parrafo, Foto],
        fields: [{ref: "Página", partial: "URL", num_parrafos: "Párrafos", num_fotos: "Fotos"}, {ref: "Página", texto: "Texto", texto_ingles: "Texto (Inglés)", p_ind: "Párrafo"}, {ref: "Página", f_ind: "Foto"}],
        imgs: [{}, {}, {foto: "Foto"}]
      }
    }
  end

  def get_object_fields
    @fields = (@sets[params[:set].to_sym][:fields].class.to_s != "Array" ? @sets[params[:set].to_sym][:fields] : @sets[params[:set].to_sym][:fields][0])
    @imgs = (@sets[params[:set].to_sym][:imgs].class.to_s != "Array" ? @sets[params[:set].to_sym][:imgs] : @sets[params[:set].to_sym][:imgs][0])
  end

  def par_params
    params.require(:parrafo).permit(:ref, :texto, :texto_ingles, :p_ind)
  end

  def pic_params
    params.require(:foto).permit(:ref, :foto, :f_ind)
  end

  def obj_params
    if params[:set] == "Profesores eméritos"
      params.require(:emerito).permit(:nombre, :fecha_anexion, :centro, :semblanza, :foto, :semblanza_eng)
    elsif params[:set] == "Programas docentes"
      params.require(:curso).permit(:titulo, :descripcion, :fecha_inicio_conv, :fecha_fin_conv, :fecha_inicio_clases, :liga, :programa, :tipo_curso, :traduccion_tit, :traduccion_desc, :tags, :fecha_fin_clases, :tipo_curso_linea, :foto, :imparte)
    elsif params[:set] == "Directorio de Autoridades"
      params.require(:personal).permit(:nombre, :seccion, :correo, :telefono, :extension, :cargo, :depto, :foto, :cargo_eng, :depto_eng)
    elsif params[:set] == "Categorías de Premios"
      params.require(:categorium).permit(:nombre,:nombre_eng)
    elsif params[:set] == "Premios y distinciones"
      params.require(:premiado).permit(:nombre, :descripcion, :tipo, :tipo_premio, :liga)
    elsif params[:set] == "Documentos varios"
      params.require(:documento).permit(:nombre, :tipo, :anio, :archivo, :nombre_eng)
    elsif params[:set] == "Descubre"
      params.require(:descubre).permit(:titulo, :liga, :contenido, :fecha_publicacion, :fecha_limite_pub, :imagen, :tags)
    elsif params[:set] == "Categorías de 'Descubre'"
      params.require(:content).permit(:tipo, :icono, :tipo_eng)
    elsif params[:set] == "Imágenes de slider"
      params.require(:slider).permit(:liga, :imagen, :badge, :posicion, :fecha_expiracion, :badge_eng)
    elsif params[:set] == "Cátedras y seminarios"
      params.require(:catedra).permit(:titulo, :titulo_eng, :descripcion_eng, :descripcion, :liga, :tipo)
    elsif params[:set] == "Frases en página principal"
      params.require(:frase).permit(:cita, :autor, :cita_eng)
    elsif params[:set] == "Directorio académico"
      params.require(:academico).permit(:nombre, :adscripcion, :lineas_investigacion, :correo, :pagina, :foto, :inicial)
    elsif params[:set] == "Usuarios gestores"
      params.require(:admin).permit(:usuario, :password, :password_confirmation, :admin)
    elsif params[:set] == "Catálogo de sitios"
      params.require(:sitio).permit(:ref, :partial, :num_parrafos, :num_fotos)
    end
  end
end
